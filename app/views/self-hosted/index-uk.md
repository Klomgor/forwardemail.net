# Власний хостинг {#self-hosted}

## Зміст {#table-of-contents}

* [Початок роботи](#getting-started)
* [Вимоги](#requirements)
  * [Cloud-init / User-data](#cloud-init--user-data)
* [встановити](#install)
  * [Сценарій встановлення налагодження](#debug-install-script)
  * [Підказки](#prompts)
  * [Початкове налаштування (Варіант 1)](#initial-setup-option-1)
* [Послуги](#services)
  * [Важливі шляхи до файлів](#important-file-paths)
* [Конфігурація](#configuration)
  * [Початкове налаштування DNS](#initial-dns-setup)
* [Онбордінг](#onboarding)
* [Тестування](#testing)
  * [Створення вашого першого псевдоніма](#creating-your-first-alias)
  * [Надсилання/отримання вашого першого електронного листа](#sending--receiving-your-first-email)
* [Усунення несправностей](#troubleshooting)
  * [Що таке базове ім’я користувача та пароль авторизації](#what-is-the-basic-auth-username-and-password)
  * [Як я знаю, що працює](#how-do-i-know-what-is-running)
  * [Як дізнатися, чи не працює щось, що має бути](#how-do-i-know-if-something-isnt-running-that-should-be)
  * [Як знайти журнали](#how-do-i-find-logs)
  * [Чому закінчується час очікування моїх вихідних електронних листів](#why-are-my-outgoing-emails-timing-out)

## Початок роботи {#getting-started}

Наше рішення електронної пошти, розміщене на власному хості, як і всі наші продукти, є на 100% відкритим кодом — і зовнішнім, і внутрішнім. Це означає:

1. **Повна прозорість**: Кожен рядок коду, який обробляє ваші електронні листи, доступний для публічного контролю.
2. **Внесок спільноти**: Будь-хто може зробити свій внесок у покращення або виправити проблеми.
3. **Безпека через відкритість**: Вразливості можуть бути виявлені та виправлені глобальною спільнотою.
4. **Відсутність прив’язаності до постачальника**: Ви ніколи не залежите від існування нашої компанії.

Вся кодова база доступна на GitHub за адресою <https://github.com/forwardemail/forwardemail.net>, ліцензована згідно з ліцензією MIT.

Архітектура містить контейнери для:

* SMTP-сервер для вихідної електронної пошти
* Сервери IMAP/POP3 для отримання електронної пошти
* Веб-інтерфейс для адміністрування
* База даних для зберігання конфігурації
* Redis для кешування та підвищення продуктивності
* SQLite для безпечного, зашифрованого зберігання поштових скриньок

> \[!NOTE]
> Be sure to check out our [self-hosted blog](https://forwardemail.net/blog/docs/self-hosted-solution)
>
> And for those interested in a more broken down step-by-step version see our [Ubuntu](https://forwardemail.net/guides/selfhosted-on-ubuntu) or [Debian](https://forwardemail.net/guides/selfhosted-on-debian) based guides.

Вимоги ## {#requirements}

Перш ніж запускати сценарій встановлення, переконайтеся, що у вас є:

* **Операційна система**: Сервер на базі Linux (наразі підтримується Ubuntu 22.04+).
* **Ресурси**: 1 віртуальний процесор та 2 ГБ оперативної пам'яті
* **Root-доступ**: Адміністративні права для виконання команд.
* **Доменне ім'я**: Власний домен, готовий до налаштування DNS.
* **Чиста IP-адреса**: Переконайтеся, що ваш сервер має чисту IP-адресу без попередньої репутації спаму, перевіривши чорні списки. Докладніше [тут](#what-tools-should-i-use-to-test-email-configuration-best-practices-and-ip-reputation).
* Публічна IP-адреса з підтримкою порту 25
* Можливість налаштування [зворотний ПТР](https://www.cloudflare.com/learning/dns/dns-records/dns-ptr-record/)
* Підтримка IPv4 та IPv6

> \[!TIP]
> See our list of [awesome mail server providers](https://github.com/forwardemail/awesome-mail-server-providers)

### Ініціалізація хмари / Дані користувача {#cloud-init--user-data}

Більшість постачальників хмарних технологій підтримують конфігурацію хмарної ініціалізації, коли надається віртуальний приватний сервер (VPS). Це чудовий спосіб завчасно встановити деякі файли та змінні середовища для використання логікою початкового налаштування сценаріїв, що дозволить уникнути необхідності запитувати додаткову інформацію під час виконання сценарію.

**Параметри**

* `EMAIL` – електронна адреса, що використовується для нагадувань про закінчення терміну дії certbot
* `DOMAIN` – користувацький домен (наприклад, `example.com`), що використовується для налаштування самостійного хостингу
* `AUTH_BASIC_USERNAME` – ім’я користувача, що використовується під час першого налаштування для захисту сайту
* `AUTH_BASIC_PASSWORD` – пароль, що використовується під час першого налаштування для захисту сайту
* `/root/.cloudflare.ini` – (**лише для користувачів Cloudflare**) файл конфігурації cloudflare, що використовується certbot для налаштування DNS. Він вимагає встановлення токена API через `dns_cloudflare_api_token`. Детальніше [тут](https://certbot-dns-cloudflare.readthedocs.io/en/stable/).

приклад:

```sh
#cloud-config
write_files:
  - path: /root/.cloudflare.ini
    content: |
      dns_cloudflare_api_token = "xxx"
    owner: root:root
    permissions: '0600'
  - path: /etc/profile.d/env.sh
    content: |
      export EMAIL="test@myemail.com"
      export DOMAIN="mydomain.com"

runcmd:
  - chmod +x /etc/profile.d/env.sh
```

## Встановити {#install}

Виконайте таку команду на своєму сервері, щоб завантажити та виконати сценарій встановлення:

```sh
bash <(curl -fsSL https://raw.githubusercontent.com/forwardemail/forwardemail.net/master/self-hosting/setup.sh)
```

### Скрипт встановлення налагодження {#debug-install-script}

Додайте `DEBUG=true` перед скриптом встановлення для отримання детального виводу:

```sh
DEBUG=true bash <(curl -fsSL https://raw.githubusercontent.com/forwardemail/forwardemail.net/master/self-hosting/setup.sh)
```

### Підказки {#prompts}

```sh
1. Initial setup
2. Setup Backups
3. Setup Auto Upgrades
4. Renew certificates
5. Restore from Backup
6. Help
7. Exit
```

* **Початкове налаштування**: Завантажте найновіший код для пересилання електронної пошти, налаштуйте середовище, запитайте свій власний домен та налаштуйте всі необхідні сертифікати, ключі та секрети.
* **Налаштування резервного копіювання**: Налаштує cron для резервного копіювання mongoDB та redis за допомогою S3-сумісного сховища для безпечного віддаленого зберігання. Окремо, sqlite буде резервно копіюватися під час входу, якщо будуть зміни для безпечних, зашифрованих резервних копій.
* **Налаштування оновлення**: Налаштуйте cron для пошуку нічних оновлень, які безпечно відновлять та перезапустять компоненти інфраструктури.
* **Поновлення сертифікатів**: Certbot / lets encrypt використовується для SSL-сертифікатів, а термін дії ключів закінчується кожні 3 місяці. Це поновить сертифікати для вашого домену та розмістить їх у потрібній папці для використання відповідними компонентами. Див. [важливі шляхи до файлів](#important-file-paths)
* **Відновлення з резервної копії**: Запустить mongodb та redis для відновлення з резервних даних.

### Початкове налаштування (Варіант 1) {#initial-setup-option-1}

Виберіть опцію `1. Initial setup`, щоб розпочати.

Після завершення ви маєте побачити повідомлення про успіх. Ви навіть можете виконати `docker ps`, щоб побачити, як **розкрутилися** компоненти. Більше інформації про компоненти нижче.

## Послуги {#services}

| Назва служби | Порт за замовчуванням | Опис |
| ------------ | :----------: | ------------------------------------------------------ |
| Інтернет | `443` | Веб-інтерфейс для всіх взаємодій адміністратора |
| API | `4000` | Рівень API для абстрактних баз даних |
| Брі | Жоден | Фонове завдання та засіб запуску завдань |
| SMTP | `465/587` | Сервер SMTP для вихідної електронної пошти |
| SMTP Брі | Жоден | Фонове завдання SMTP |
| MX | `2525` | Обмін поштою для вхідної електронної пошти та пересилання електронної пошти |
| IMAP | `993/2993` | Сервер IMAP для вхідної електронної пошти та керування поштовою скринькою |
| POP3 | `995/2995` | Сервер POP3 для вхідної електронної пошти та керування поштовою скринькою |
| SQLite | `3456` | Сервер SQLite для взаємодії з базами даних sqlite |
| SQLite Брі | Жоден | Фонова робота SQLite |
| CalDAV | `5000` | Сервер CalDAV для керування календарем |
| CardDAV | `6000` | Сервер CardDAV для керування календарем |
| MongoDB | `27017` | База даних MongoDB для управління більшістю даних |
| Redis | `6379` | Redis для кешування та керування станом |
| SQLite | Жоден | База даних SQLite для зашифрованих поштових скриньок |

### Важливі шляхи до файлів {#important-file-paths}

Примітка: *Шлях до хоста* нижче вказано відносно `/root/forwardemail.net/self-hosting/`.

| компонент | Шлях хоста | Контейнерний шлях |
| ---------------------- | :-------------------: | ---------------------------- |
| MongoDB | `./mongo-backups` | `/backups` |
| Redis | `./redis-data` | `/data` |
| Sqlite | `./sqlite-data` | `/mnt/{SQLITE_STORAGE_PATH}` |
| Env файл | `./.env` | `/app/.env` |
| Сертифікати/ключі SSL | `./ssl` | `/app/ssl/` |
| Приватний ключ | `./ssl/privkey.pem` | `/app/ssl/privkey.pem` |
| Сертифікат повного ланцюга | `./ssl/fullchain.pem` | `/app/ssl/fullchain.pem` |
| сертифікати ЦС | `./ssl/cert.pem` | `/app/ssl/cert.pem` |
| Закритий ключ DKIM | `./ssl/dkim.key` | `/app/ssl/dkim.key` |

> \[!IMPORTANT]
> Save the `.env` file securely. It is critical for recovery in case of failure.
> You can find this in `/root/forwardemail.net/self-hosting/.env`.

Конфігурація ## {#configuration}

### Початкове налаштування DNS {#initial-dns-setup}

У вибраному вами постачальнику DNS налаштуйте відповідні DNS-записи. Зверніть увагу, що все в дужках (`<>`) є динамічним і потребує оновлення відповідно до вашого значення.

| Тип | Ім'я | Зміст | TTL |
| ----- | ------------------ | ----------------------------- | ---- |
| A | "@", "." або пусто | <ip_address> | авто |
| CNAME | api | <назва_домену> | авто |
| CNAME | кальдав | <назва_домену> | авто |
| CNAME | карддав | <назва_домену> | авто |
| CNAME | фе-підскоки | <назва_домену> | авто |
| CNAME | imap | <назва_домену> | авто |
| CNAME | mx | <назва_домену> | авто |
| CNAME | поп3 | <назва_домену> | авто |
| CNAME | smtp | <назва_домену> | авто |
| MX | "@", "." або пусто | mx.<domain_name> (пріоритет 0) | авто |
| TXT | "@", "." або пусто | "v=spf1 a -все" | авто |

#### Зворотний DNS / PTR запис {#reverse-dns--ptr-record}

Зворотний DNS (rDNS) або записи зворотного вказівника (записи PTR) важливі для серверів електронної пошти, оскільки вони допомагають перевірити легітимність сервера, який надсилає електронний лист. Кожен хмарний постачальник робить це по-різному, тому вам потрібно буде знайти, як додати «Зворотний DNS», щоб зіставити хост та IP-адресу з відповідним іменем хоста. Швидше за все в мережевому розділі провайдера.

#### Порт 25 заблоковано {#port-25-blocked}

Деякі інтернет-провайдери та хмарні провайдери блокують 25, щоб уникнути зловмисників. Можливо, вам знадобиться подати заявку в службу підтримки, щоб відкрити порт 25 для SMTP/вихідної електронної пошти.

## Реєстрація {#onboarding}

1. Відкрийте цільову сторінку
Перейдіть за посиланням https\://\<ім’я_домену>, замінивши \<ім’я_домену> доменом, налаштованим у ваших налаштуваннях DNS. Ви маєте побачити цільову сторінку пересилання електронної пошти.

2. Увійдіть та зареєструйте свій домен

* Увійдіть, використовуючи дійсну електронну адресу та пароль.
* Введіть доменне ім’я, яке ви хочете налаштувати (воно має відповідати конфігурації DNS).
* Дотримуйтесь інструкцій, щоб додати необхідні записи **MX** та **TXT** для перевірки.

3. Завершіть налаштування

* Після підтвердження перейдіть на сторінку «Псевдоніми», щоб створити свій перший псевдонім.
* За потреби налаштуйте **SMTP для вихідної електронної пошти** у **Налаштуваннях домену**. Для цього потрібні додаткові записи DNS.

> \[!NOTE]
> No information is sent outside of your server. The self hosted option and initial account is just for the admin login and web view to manage domains, aliases and related email configurations.

## Тестування {#testing}

### Створення вашого першого псевдоніма {#creating-your-first-alias}

1. Перейдіть на сторінку «Псевдоніми»
Відкрийте сторінку керування псевдонімами:

```sh
https://<domain_name>/en/my-account/domains/<domain_name>/aliases
```

2. Додайте новий псевдонім

* Натисніть **Додати псевдонім** (угорі праворуч).
* Введіть псевдонім і за потреби налаштуйте параметри електронної пошти.
* (Необов’язково) Увімкніть підтримку **IMAP/POP3/CalDAV/CardDAV**, встановивши прапорець.
* Натисніть **Створити псевдонім**.

3. Встановіть пароль

* Натисніть **Згенерувати пароль**, щоб створити надійний пароль.
* Цей пароль буде потрібен для входу у ваш поштовий клієнт.

4. Налаштуйте свій поштовий клієнт

* Використовуйте поштовий клієнт, такий як Thunderbird.
* Введіть псевдонім та згенерований пароль.
* Налаштуйте параметри **IMAP** та **SMTP** відповідно.

#### Налаштування поштового сервера {#email-server-settings}

Ім'я користувача: `<alias name>`

| Тип | Ім'я хоста | Порт | Безпека підключення | Автентифікація |
| ---- | ------------------ | ---- | ------------------- | --------------- |
| SMTP | smtp.<ім'я_домену> | 465 | SSL / TLS | Звичайний пароль |
| IMAP | imap.<ім'я_домену> | 993 | SSL / TLS | Звичайний пароль |

### Надсилання / отримання вашого першого електронного листа {#sending--receiving-your-first-email}

Після налаштування ви зможете надсилати та отримувати електронну пошту на свою щойно створену адресу електронної пошти!

## Виправлення неполадок {#troubleshooting}

#### Чому це не працює поза межами Ubuntu та Debian {#why-doesnt-this-work-outside-of-ubuntu-and-debian}

Наразі ми шукаємо підтримку для MacOS і будемо шукати інших. Будь ласка, відкрийте [обговорення](https://github.com/orgs/forwardemail/discussions) або зробіть свій внесок, якщо ви хочете, щоб інші отримали підтримку.

#### Чому тест certbot acme не проходить {#why-is-the-certbot-acme-challenge-failing}

Найпоширеніша помилка полягає в тому, що certbot / letsencrypt іноді запитує **2** запити. Вам потрібно переконатися, що ви додали **ОБИДВА** текстові записи.

Приклад:
Ви можете побачити два подібні завдання:
\_acme-challenge.example.com -> "randomstring1"
\_acme-challenge.example.com -> "randomstring2"

Також можливо, що поширення DNS не завершено. Ви можете скористатися такими інструментами, як: `https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.<your_domain>`. Це дасть вам уявлення про те, чи слід відображати зміни у вашому TXT-записі. Також можливо, що локальний кеш DNS на вашому хості все ще використовує старе, неактуальне значення або не врахував останні зміни.

Інший варіант – використовувати автоматичні зміни DNS cerbot, встановивши файл `/root/.cloudflare.ini` з токеном API у вашому cloud-init / user-data під час початкового налаштування VPS або створіть цей файл і запустіть скрипт ще раз. Це автоматично керуватиме змінами DNS та викликатиме оновлення.

### Яке основне ім'я користувача та пароль для авторизації {#what-is-the-basic-auth-username-and-password}

Для самостійного хостингу ми додаємо спливаюче вікно для першої автентифікації в браузері з простим ім'ям користувача (`admin`) та паролем (випадковим чином згенерованим під час початкового налаштування). Ми додаємо це просто як захист на випадок, якщо автоматизація/парсери якимось чином виманять вас під час першої реєстрації в веб-інтерфейсі. Ви можете знайти цей пароль після початкового налаштування у вашому файлі `.env` у розділах `AUTH_BASIC_USERNAME` та `AUTH_BASIC_PASSWORD`.

### Як дізнатися, що працює {#how-do-i-know-what-is-running}

Ви можете виконати команду `docker ps`, щоб побачити всі запущені контейнери, які розкручуються з файлу `docker-compose-self-hosting.yml`. Ви також можете виконати команду `docker ps -a`, щоб побачити все (включно з контейнерами, які не запущені).

### Як дізнатися, чи щось не працює, а мало б бути {#how-do-i-know-if-something-isnt-running-that-should-be}

Ви можете виконати команду `docker ps -a`, щоб побачити все (включно з контейнерами, які не запущені). Ви можете побачити журнал завершення або примітку.

### Як знайти журнали {#how-do-i-find-logs}

Ви можете отримати більше журналів через `docker logs -f <container_name>`. Якщо щось завершилося, це, ймовірно, пов'язано з неправильним налаштуванням файлу `.env`.

У веб-інтерфейсі ви можете переглянути `/admin/emails` та `/admin/logs` для журналів вихідної електронної пошти та журналів помилок відповідно.

### Чому час очікування моїх вихідних електронних листів закінчується {#why-are-my-outgoing-emails-timing-out}

Якщо під час підключення до MX-сервера ви бачите повідомлення на кшталт «Час очікування з’єднання минув», можливо, вам потрібно перевірити, чи не заблоковано порт 25. Інтернет-провайдери або хмарні провайдери зазвичай блокують це за замовчуванням, коли вам може знадобитися зв’язатися з підтримкою або подати заявку, щоб відкрити це.

#### Які інструменти слід використовувати для перевірки найкращих практик налаштування електронної пошти та репутації IP-адрес {#what-tools-should-i-use-to-test-email-configuration-best-practices-and-ip-reputation}

Перегляньте наше [FAQ тут](/faq#why-are-my-emails-landing-in-spam-and-junk-and-how-can-i-check-my-domain-reputation).
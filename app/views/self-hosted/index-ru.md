# Размещенный самостоятельно {#self-hosted}

## Содержание {#table-of-contents}

* [Начиная](#getting-started)
* [Требования](#requirements)
  * [Cloud-init / Пользовательские данные](#cloud-init--user-data)
* [Установить](#install)
  * [Отладочный скрипт установки](#debug-install-script)
  * [Подсказки](#prompts)
  * [Начальная настройка (вариант 1)](#initial-setup-option-1)
* [Услуги](#services)
  * [Важные пути к файлам](#important-file-paths)
* [Конфигурация](#configuration)
  * [Первоначальная настройка DNS](#initial-dns-setup)
* [Адаптация](#onboarding)
* [Тестирование](#testing)
  * [Создание вашего первого псевдонима](#creating-your-first-alias)
  * [Отправка/получение вашего первого электронного письма](#sending--receiving-your-first-email)
* [Поиск неисправностей](#troubleshooting)
  * [Что такое базовое имя пользователя и пароль для аутентификации?](#what-is-the-basic-auth-username-and-password)
  * [Как узнать, что запущено?](#how-do-i-know-what-is-running)
  * [Как узнать, что что-то не работает, хотя должно работать?](#how-do-i-know-if-something-isnt-running-that-should-be)
  * [Как найти журналы?](#how-do-i-find-logs)
  * [Почему мои исходящие письма истекают по тайм-ауту?](#why-are-my-outgoing-emails-timing-out)

## Начало работы {#getting-started}

Наше решение для самостоятельного размещения электронной почты, как и все наши продукты, на 100% открытое — как frontend, так и backend. Это означает:

1. **Полная прозрачность**: каждая строка кода, обрабатывающая ваши электронные письма, доступна для публичного контроля.
2. **Вклад сообщества**: каждый может вносить улучшения или устранять проблемы.
3. **Безопасность через открытость**: уязвимости могут быть выявлены и устранены мировым сообществом.
4. **Отсутствие привязки к поставщику**: вы никогда не зависите от существования нашей компании.

Вся кодовая база доступна на GitHub по адресу <https://github.com/forwardemail/forwardemail.net>, под лицензией MIT.

Архитектура включает контейнеры для:

* SMTP-сервер для исходящей почты
* IMAP/POP3-серверы для получения электронной почты
* Веб-интерфейс для администрирования
* База данных для хранения конфигурации
* Redis для кэширования и производительности
* SQLite для безопасного, зашифрованного хранения почтовых ящиков

> \[!NOTE]
> Be sure to check out our [self-hosted blog](https://forwardemail.net/blog/docs/self-hosted-solution)
>
> And for those interested in a more broken down step-by-step version see our [Ubuntu](https://forwardemail.net/guides/selfhosted-on-ubuntu) or [Debian](https://forwardemail.net/guides/selfhosted-on-debian) based guides.

## Требования {#requirements}

Перед запуском скрипта установки убедитесь, что у вас есть следующее:

* **Операционная система**: Сервер на базе Linux (в настоящее время поддерживается Ubuntu 22.04+).
* **Ресурсы**: 1 виртуальный ЦП и 2 ГБ ОЗУ
* **Root-доступ**: Административные права для выполнения команд.
* **Доменное имя**: Пользовательский домен, готовый к настройке DNS.
* **Чистый IP**: Убедитесь, что у вашего сервера чистый IP-адрес без спама, проверив чёрные списки. Подробнее [здесь](#what-tools-should-i-use-to-test-email-configuration-best-practices-and-ip-reputation).
* Публичный IP-адрес с поддержкой порта 25
* Возможность настройки [обратный ПТР](https://www.cloudflare.com/learning/dns/dns-records/dns-ptr-record/)
* Поддержка IPv4 и IPv6

> \[!TIP]
> See our list of [awesome mail server providers](https://github.com/forwardemail/awesome-mail-server-providers)

### Cloud-init / Пользовательские данные {#cloud-init--user-data}

Большинство поставщиков облачных услуг поддерживают конфигурацию cloud-init для случаев, когда предоставляется виртуальный частный сервер (VPS). Это отличный способ заранее задать некоторые файлы и переменные среды для использования в начальной настройке скриптов, что позволит обойти необходимость запрашивать дополнительную информацию во время работы скрипта.

**Параметры**

* `EMAIL` — адрес электронной почты, используемый для напоминаний об истечении срока действия сертификата Certbot.
* `DOMAIN` — пользовательский домен (например, `example.com`), используемый для настройки собственного хостинга.
* `AUTH_BASIC_USERNAME` — имя пользователя, используемое при первой настройке для защиты сайта.
* `AUTH_BASIC_PASSWORD` — пароль, используемый при первой настройке для защиты сайта.
* `/root/.cloudflare.ini` — (**Только для пользователей Cloudflare**) файл конфигурации Cloudflare, используемый Certbot для настройки DNS. Требуется указать свой API-токен через `dns_cloudflare_api_token`. Подробнее [здесь](https://certbot-dns-cloudflare.readthedocs.io/en/stable/).

Пример:

```sh
#cloud-config
write_files:
  - path: /root/.cloudflare.ini
    content: |
      dns_cloudflare_api_token = "xxx"
    owner: root:root
    permissions: '0600'
  - path: /etc/profile.d/env.sh
    content: |
      export EMAIL="test@myemail.com"
      export DOMAIN="mydomain.com"

runcmd:
  - chmod +x /etc/profile.d/env.sh
```

## Установить {#install}

Выполните следующую команду на своем сервере, чтобы загрузить и выполнить установочный скрипт:

```sh
bash <(curl -fsSL https://raw.githubusercontent.com/forwardemail/forwardemail.net/master/self-hosting/setup.sh)
```

### Отладочный скрипт установки {#debug-install-script}

Добавьте `DEBUG=true` перед скриптом установки для подробного вывода:

```sh
DEBUG=true bash <(curl -fsSL https://raw.githubusercontent.com/forwardemail/forwardemail.net/master/self-hosting/setup.sh)
```

### Подсказки {#prompts}

```sh
1. Initial setup
2. Setup Backups
3. Setup Auto Upgrades
4. Renew certificates
5. Restore from Backup
6. Help
7. Exit
```

* **Начальная настройка**: Загрузите последний код пересылки электронной почты, настройте среду, запросите ваш домен и настройте все необходимые сертификаты, ключи и секреты.
* **Настройка резервного копирования**: Настроит cron для резервного копирования MongoDB и Redis с использованием S3-совместимого хранилища для безопасного удаленного хранения. Кроме того, резервное копирование SQLite будет выполняться при входе в систему при наличии изменений для безопасного зашифрованного резервного копирования.
* **Настройка обновления**: Настроит cron для поиска ночных обновлений, которые безопасно пересоберут и перезапустят компоненты инфраструктуры.
* **Обновление сертификатов**: Certbot / lets encrypt используется для SSL-сертификатов, а ключи истекают каждые 3 месяца. Это обновит сертификаты для вашего домена и поместит их в нужную папку для использования соответствующими компонентами. См. [важные пути к файлам](#important-file-paths)
* **Восстановление из резервной копии**: Запустит восстановление MongoDB и Redis из резервной копии.

### Начальная настройка (Вариант 1) {#initial-setup-option-1}

Чтобы начать, выберите опцию `1. Initial setup`.

После завершения вы увидите сообщение об успешном завершении. Вы также можете запустить `docker ps`, чтобы увидеть **запущенные** компоненты. Подробнее о компонентах ниже.

## Услуги {#services}

| Название услуги | Порт по умолчанию | Описание |
| ------------ | :----------: | ------------------------------------------------------ |
| Веб | `443` | Веб-интерфейс для всех административных взаимодействий |
| API | `4000` | Уровень API для абстрагирования баз данных |
| Бри | Никто | Фоновое задание и исполнитель задач |
| SMTP | `465/587` | SMTP-сервер для исходящей электронной почты |
| SMTP Бри | Никто | Фоновое задание SMTP |
| MX | `2525` | Обмен почтой для входящей электронной почты и переадресация электронной почты |
| IMAP | `993/2993` | IMAP-сервер для входящей электронной почты и управления почтовыми ящиками |
| POP3 | `995/2995` | POP3-сервер для входящей электронной почты и управления почтовыми ящиками |
| SQLite | `3456` | Сервер SQLite для взаимодействия с базами данных SQLite |
| SQLite Бри | Никто | Фоновое задание SQLite |
| CalDAV | `5000` | Сервер CalDAV для управления календарем |
| CardDAV | `6000` | Сервер CardDAV для управления календарем |
| MongoDB | `27017` | База данных MongoDB для большинства задач управления данными |
| Редис | `6379` | Redis для кэширования и управления состоянием |
| SQLite | Никто | База данных SQLite для зашифрованных почтовых ящиков |

### Важные пути к файлам {#important-file-paths}

Примечание: *Путь к хосту* ниже указан относительно `/root/forwardemail.net/self-hosting/`.

| Компонент | Путь к хосту | Путь контейнера |
| ---------------------- | :-------------------: | ---------------------------- |
| MongoDB | `./mongo-backups` | `/backups` |
| Редис | `./redis-data` | `/data` |
| SQLite | `./sqlite-data` | `/mnt/{SQLITE_STORAGE_PATH}` |
| Файл Env | `./.env` | `/app/.env` |
| SSL-сертификаты/ключи | `./ssl` | `/app/ssl/` |
| Закрытый ключ | `./ssl/privkey.pem` | `/app/ssl/privkey.pem` |
| Сертификат полной цепочки | `./ssl/fullchain.pem` | `/app/ssl/fullchain.pem` |
| Сертифицированные центры сертификации | `./ssl/cert.pem` | `/app/ssl/cert.pem` |
| Закрытый ключ DKIM | `./ssl/dkim.key` | `/app/ssl/dkim.key` |

> \[!IMPORTANT]
> Save the `.env` file securely. It is critical for recovery in case of failure.
> You can find this in `/root/forwardemail.net/self-hosting/.env`.

## Конфигурация {#configuration}

### Первоначальная настройка DNS {#initial-dns-setup}

Настройте соответствующие записи DNS у выбранного вами DNS-провайдера. Обратите внимание, что всё, что указано в скобках (`<>`), является динамическим и должно быть обновлено с учётом вашего значения.

| Тип | Имя | Содержание | TTL |
| ----- | ------------------ | ----------------------------- | ---- |
| A | «@», «.» или пробел | <ip_адрес> | авто |
| CNAME | апи | <имя_домена> | авто |
| CNAME | калдав | <имя_домена> | авто |
| CNAME | карддав | <имя_домена> | авто |
| CNAME | fe-отскоки | <имя_домена> | авто |
| CNAME | IMAP | <имя_домена> | авто |
| CNAME | мх | <имя_домена> | авто |
| CNAME | поп3 | <имя_домена> | авто |
| CNAME | SMTP-протокол | <имя_домена> | авто |
| MX | «@», «.» или пробел | mx.<имя_домена> (приоритет 0) | авто |
| TXT | «@», «.» или пробел | "v=spf1 a -все" | авто |

#### Обратная запись DNS/PTR {#reverse-dns--ptr-record}

Обратные DNS (rDNS) или записи обратного указателя (записи PTR) необходимы для серверов электронной почты, поскольку они помогают проверить легитимность сервера, отправляющего электронное письмо. Каждый поставщик облачных услуг делает это по-разному, поэтому вам нужно будет поискать, как добавить «Обратный DNS» для сопоставления хоста и IP с соответствующим именем хоста. Скорее всего, в сетевом разделе провайдера.

#### Порт 25 заблокирован {#port-25-blocked}

Некоторые интернет-провайдеры и поставщики облачных услуг блокируют порт 25, чтобы избежать злоумышленников. Вам может потребоваться подать заявку в службу поддержки, чтобы открыть порт 25 для SMTP / исходящей почты.

## Вводная {#onboarding}

1. Откройте целевую страницу.
Перейдите по адресу https\://\<имя_домена>, заменив \<имя_домена> на домен, указанный в настройках DNS. Вы увидите целевую страницу «Пересылка электронной почты».

2. Войдите в систему и зарегистрируйте свой домен

* Войдите, используя действительный адрес электронной почты и пароль.
* Введите доменное имя, которое вы хотите настроить (оно должно соответствовать конфигурации DNS).
* Следуйте инструкциям, чтобы добавить необходимые записи **MX** и **TXT** для проверки.

3. Завершите настройку

* После проверки перейдите на страницу Псевдонимы, чтобы создать свой первый псевдоним.
* При желании настройте **SMTP для исходящей почты** в **Настройках домена**. Для этого потребуются дополнительные записи DNS.

> \[!NOTE]
> No information is sent outside of your server. The self hosted option and initial account is just for the admin login and web view to manage domains, aliases and related email configurations.

## Тестирование {#testing}

### Создание вашего первого псевдонима {#creating-your-first-alias}

1. Перейдите на страницу псевдонимов
Откройте страницу управления псевдонимами:

```sh
https://<domain_name>/en/my-account/domains/<domain_name>/aliases
```

2. Добавить новый псевдоним

* Нажмите **Добавить псевдоним** (вверху справа).
* Введите имя псевдонима и при необходимости измените настройки электронной почты.
* (Необязательно) Включите поддержку **IMAP/POP3/CalDAV/CardDAV**, установив флажок.
* Нажмите **Создать псевдоним**.

3. Установите пароль

* Нажмите **Сгенерировать пароль**, чтобы создать безопасный пароль.
* Этот пароль потребуется для входа в ваш почтовый клиент.

4. Настройте свой почтовый клиент

* Используйте почтовый клиент, например Thunderbird.
* Введите псевдоним и сгенерированный пароль.
* Настройте параметры **IMAP** и **SMTP** соответствующим образом.

#### Настройки почтового сервера {#email-server-settings}

Имя пользователя: `<alias name>`

| Тип | Имя хоста | Порт | Безопасность соединения | Аутентификация |
| ---- | ------------------ | ---- | ------------------- | --------------- |
| SMTP | smtp.<имя_домена> | 465 | SSL / TLS | Обычный пароль |
| IMAP | imap.<имя_домена> | 993 | SSL / TLS | Обычный пароль |

### Отправка/получение вашего первого электронного письма {#sending--receiving-your-first-email}

После настройки вы сможете отправлять и получать электронную почту на свой только что созданный и размещенный на собственном сервере адрес электронной почты!

## Устранение неполадок {#troubleshooting}

#### Почему это не работает за пределами Ubuntu и Debian {#why-doesnt-this-work-outside-of-ubuntu-and-debian}

В настоящее время мы ищем поддержку MacOS и будем рассматривать другие платформы. Если вы хотите, чтобы другие тоже получили поддержку, пожалуйста, перейдите по ссылке [обсуждение](https://github.com/orgs/forwardemail/discussions) или внесите свой вклад.

#### Почему не проходит тест certbot acme {#why-is-the-certbot-acme-challenge-failing}

Наиболее распространенная ловушка заключается в том, что certbot / letsencrypt иногда запрашивает **2** вызова. Вам нужно убедиться, что вы добавили **ОБЕ** записи txt.

Пример:
Вы можете увидеть два вызова, подобных этому:
\_acme-challenge.example.com -> "randomstring1"
\_acme-challenge.example.com -> "randomstring2"

Также возможно, что распространение DNS не завершено. Вы можете использовать такие инструменты, как: `https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.<your_domain>`. Это даст вам представление о том, следует ли отражать изменения вашей TXT-записи. Также возможно, что локальный DNS-кэш на вашем хосте всё ещё использует старое, неактуальное значение или не отразил последние изменения.

Другой вариант — использовать автоматическое изменение DNS с помощью Cerbot, добавив файл `/root/.cloudflare.ini` с токеном API в файл cloud-init/user-data при первоначальной настройке VPS или создав этот файл и повторно запустив скрипт. Это позволит автоматически управлять изменениями DNS и обновлениями запросов.

### Какое имя пользователя и пароль для базовой аутентификации {#what-is-the-basic-auth-username-and-password}

Для самостоятельного хостинга мы добавляем всплывающее окно для первоначальной аутентификации в браузере с простым именем пользователя (`admin`) и паролем (сгенерированным случайным образом при первоначальной настройке). Мы добавляем это просто для защиты на случай, если автоматизация или парсеры каким-либо образом помешают вам пройти первоначальную регистрацию на сайте. После первоначальной настройки этот пароль можно найти в файле `.env` в разделах `AUTH_BASIC_USERNAME` и `AUTH_BASIC_PASSWORD`.

### Как узнать, что запущено {#how-do-i-know-what-is-running}

Вы можете запустить `docker ps`, чтобы увидеть все запущенные контейнеры, которые запускаются из файла `docker-compose-self-hosting.yml`. Вы также можете запустить `docker ps -a`, чтобы увидеть все контейнеры (включая не запущенные).

### Как узнать, что что-то не работает, что должно быть {#how-do-i-know-if-something-isnt-running-that-should-be}

Вы можете запустить `docker ps -a`, чтобы увидеть всё (включая неработающие контейнеры). Вы можете увидеть журнал выхода или примечание.

### Как найти журналы {#how-do-i-find-logs}

Дополнительные журналы можно получить через `docker logs -f <container_name>`. Если что-то не работает, это, вероятно, связано с неправильной настройкой файла `.env`.

В веб-интерфейсе вы можете просмотреть `/admin/emails` и `/admin/logs` для журналов исходящей электронной почты и журналов ошибок соответственно.

### Почему мои исходящие письма истекают по тайм-ауту {#why-are-my-outgoing-emails-timing-out}

Если вы видите сообщение типа Connection timed out при подключении к MX-серверу..., вам, возможно, следует проверить, не заблокирован ли порт 25. Обычно интернет-провайдеры или поставщики облачных услуг блокируют его по умолчанию, и вам, возможно, придется обратиться в службу поддержки или подать тикет, чтобы его открыть.

#### Какие инструменты следует использовать для проверки передовых методов настройки электронной почты и репутации IP-адреса {#what-tools-should-i-use-to-test-email-configuration-best-practices-and-ip-reputation}

Взгляните на нашу [Часто задаваемые вопросы здесь](/faq#why-are-my-emails-landing-in-spam-and-junk-and-how-can-i-check-my-domain-reputation).